---
import { Image } from 'astro:assets';
import Layout from '../../layouts/Layout.astro';
import { getEntry, getCollection } from "astro:content";

const projectEntries = await getCollection("projects");
const projects = projectEntries.sort((a, b) => {
  const yearA = parseInt(a.data.date.split('-').pop());
  const yearB = parseInt(b.data.date.split('-').pop());
  return yearB - yearA;
});

const { slug } = Astro.params;

if (slug === undefined) {
  throw new Error("Slug is required");
}

const entry = await getEntry("projects", slug);

if (entry === undefined) {
  return Astro.redirect("/404");
}

let previous = null, next = null;

const currentIndex = projects.findIndex(entry => entry.slug === slug);

if (currentIndex > 0) {
  previous = projects[currentIndex - 1];
}

if (currentIndex < projects.length - 1) {
  next = projects[currentIndex + 1];
}

const { Content } = await entry.render();
const { title, image, gallery, date, tag, location, role, credit, link } = entry.data;
---

<Layout title={`${title} | R.M. Ristow`}>
  <div class="relative">
    <div class="mx-auto px-8 md:max-w-7xl">
      <section class="py-12 md:py-20">

        <!-- Title and metadata -->
        <div class="max-w-4xl mx-auto mb-12">
          <h1 class="font-heading text-4xl md:text-5xl font-light tracking-wide mb-8">{title}</h1>

          <div class="grid grid-cols-2 md:grid-cols-4 gap-6 mb-8">
            {location && (
              <div>
                <h2 class="text-sm font-medium uppercase tracking-wider text-zinc-400 mb-1">Location</h2>
                <p class="text-zinc-800">{location}</p>
              </div>
            )}
            {date && (
              <div>
                <h2 class="text-sm font-medium uppercase tracking-wider text-zinc-400 mb-1">Date</h2>
                <p class="text-zinc-800">{date}</p>
              </div>
            )}
            {role && (
              <div>
                <h2 class="text-sm font-medium uppercase tracking-wider text-zinc-400 mb-1">Role</h2>
                <p class="text-zinc-800">{role}</p>
              </div>
            )}
            {credit && (
              <div>
                <h2 class="text-sm font-medium uppercase tracking-wider text-zinc-400 mb-1">Credit</h2>
                <p class="text-zinc-800">{credit}</p>
              </div>
            )}
            {link && (
              <div>
                <h2 class="text-sm font-medium uppercase tracking-wider text-zinc-400 mb-1">Link</h2>
                <a href={link.url} target="_blank" rel="noopener" class="text-zinc-800 underline hover:text-zinc-600 transition-colors">{link.text}</a>
              </div>
            )}
          </div>

          <div class="prose prose-zinc max-w-none">
            <Content />
          </div>
        </div>

        <!-- Cover image -->
        <div class="max-w-5xl mx-auto mb-8">
          <Image width={1200} src={image} alt={title} class="w-full h-auto" />
        </div>

        <!-- Gallery -->
        {gallery && gallery.length > 0 && (
          <div class="max-w-5xl mx-auto">
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
              {gallery.map((img, i) => (
                <div class={i === 0 || (gallery.length % 2 !== 0 && i === gallery.length - 1) ? 'md:col-span-2' : ''}>
                  <Image width={1200} src={img} alt={`${title} - Image ${i + 2}`} class="w-full h-auto" loading="lazy" />
                </div>
              ))}
            </div>
          </div>
        )}

        <!-- Previous/Next navigation -->
        <div class="mt-16 flex items-center justify-between gap-6 w-full mx-auto max-w-5xl mb-12 flex-col md:flex-row">
          {previous ? (
            <a href={`/project/${previous.slug}`} class="text-xs no-underline cursor-pointer font-bold leading-5 inline-block uppercase tracking-[0.12em] relative">
              <span class="relative block transition duration-500 ease-in-out transform rounded hover:scale-105">
                <Image width={244} class="relative block object-cover object-center max-w-[260px] h-auto max-h-[260px]" loading="lazy" alt={previous.data.title} src={previous.data.image} />
              </span>
              <span class="absolute max-w-[100px] -translate-y-1/2 -translate-x-full left-[30px] top-1/2 bg-white py-1 px-2">Previous Project</span>
            </a>
          ) : <span />}
          {next ? (
            <a href={`/project/${next.slug}`} class="text-xs no-underline cursor-pointer font-bold leading-5 inline-block uppercase tracking-[0.12em] relative">
              <span class="relative block transition duration-500 ease-in-out transform rounded hover:scale-105">
                <Image width={244} class="relative block object-cover object-center max-w-[260px] h-auto max-h-[260px]" loading="lazy" alt={next.data.title} src={next.data.image} />
              </span>
              <span class="absolute max-w-[100px] -translate-y-1/2 translate-x-full right-[30px] top-1/2 bg-white py-1 px-2">Next Project</span>
            </a>
          ) : <span />}
        </div>
      </section>
    </div>
  </div>
</Layout>
